<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>VTTL - Virtual Tabletop</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            overflow: hidden;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #playcanvas-app {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        #ui-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
        }
        
        #connection-status {
            margin-bottom: 10px;
        }
        
        .connected { color: #4CAF50; }
        .disconnected { color: #f44336; }
        .connecting { color: #ff9800; }
        
        #entity-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .entity-item {
            background: rgba(255, 255, 255, 0.1);
            margin: 2px 0;
            padding: 5px;
            border-radius: 3px;
            font-size: 11px;
        }
        
        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
        }
        
        button {
            background: #333;
            color: white;
            border: 1px solid #666;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        button:hover {
            background: #555;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 999;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="loading">
            <h2>Loading VTTL...</h2>
            <p>Initializing PlayCanvas Engine...</p>
        </div>
        
        <canvas id="playcanvas-app"></canvas>
        
        <div id="ui-overlay">
            <div id="version-info" style="font-size: 10px; color: #888; margin-bottom: 5px;">
                VTTL v<span id="version-number">Loading...</span>
            </div>
            <div id="connection-status" class="connecting">
                üîÑ Connecting to server...
            </div>
            <div>
                <strong>Entities:</strong> <span id="entity-count">0</span>
            </div>
            <div id="entity-list"></div>
        </div>
        
        <div id="controls">
            <div style="margin-bottom: 10px;">
                <strong style="color: white; font-size: 11px;">GLB Models:</strong><br>
                <button onclick="loadGLBModel('cat')">üê± Load Cat</button>
                <button onclick="loadGLBModel('eagle')">ü¶Ö Load Eagle</button>
                <button onclick="loadRandomGLBModel()">üé≤ Random Model</button>
            </div>
            
            <div style="margin-bottom: 10px;">
                <strong style="color: white; font-size: 11px;">Basic Controls:</strong><br>
                <button onclick="testCreateEntity()">Create Test Cube</button>
                <button onclick="testMoveEntity()">Move Last Entity</button>
                <button onclick="clearScene()">Clear Scene</button>
            </div>
            
            <div style="margin-bottom: 10px;">
                <strong style="color: white; font-size: 11px;">Showcase:</strong><br>
                <button onclick="loadModelShowcase()">üé¨ Model Showcase</button>
            </div>
            
            <div>
                <strong style="color: white; font-size: 11px;">Advanced:</strong><br>
                <button onclick="gameController.runDemo()">Run Demo</button>
                <button onclick="gameController.movePiecesInCircle()">Move Pieces</button>
                <button onclick="takeScreenshot()">Screenshot</button>
            </div>
        </div>
    </div>

    <!-- PlayCanvas Engine -->
    <script src="https://code.playcanvas.com/playcanvas-stable.min.js"></script>
    
    <!-- Game Scripts -->
    <script src="entity-classes.js"></script>
    <script src="game-controller.js"></script>
    <script src="app.js"></script>
    
    <script>
        // Global variables for testing
        let lastEntityName = null;
        let entityCounter = 0;
        
        // Update version display when game controller loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (typeof gameController !== 'undefined' && gameController.version) {
                    const versionElement = document.getElementById('version-number');
                    if (versionElement) {
                        versionElement.textContent = gameController.version;
                    }
                    console.log(`üè∑Ô∏è UI Version Display: ${gameController.version}`);
                }
            }, 100);
        });
        
        // Test functions accessible from UI
        function testCreateEntity() {
            entityCounter++;
            const name = `mini_test_${entityCounter}`;
            lastEntityName = name;
            
            gameController.createEntity({
                name: name,
                template: 'cube',
                position: [
                    Math.random() * 10 - 5,
                    0.5,  // Place cubes above table level
                    Math.random() * 10 - 5
                ],
                owner: 'test_player'
            });
        }
        
        function testMoveEntity() {
            if (lastEntityName) {
                gameController.moveEntity({
                    name: lastEntityName,
                    to: [
                        Math.random() * 10 - 5,
                        0.5,  // Maintain table level
                        Math.random() * 10 - 5
                    ],
                    animate: true
                });
            }
        }
        
        function testCreateBoard() {
            gameController.setupBoard({
                type: 'square',
                size: 1,
                width: 10,
                height: 10,
                createTiles: true
            });
        }
        
        function clearScene() {
            // This will be implemented in the game controller
            gameController.clearScene();
        }

        function takeScreenshot() {
            gameController.sendScreenshot();
        }
        
        // GLB Model Loading Functions
        let glbModelCounter = 0;
        
        function loadGLBModel(modelType) {
            if (!gameController || !gameController.isConnected) {
                alert('Not connected to server. Please wait for connection.');
                return;
            }
            
            glbModelCounter++;
            const modelName = `${modelType}_${glbModelCounter}`;
            const glbFile = `${modelType}.glb`;
            
            console.log(`üéÆ Loading GLB model: ${modelName} from ${glbFile}`);
            
            // Create GLB model entity via WebSocket
            gameController.sendMessage('create_entity', {
                name: modelName,
                template: glbFile,  // This triggers GLB loading
                position: [
                    Math.random() * 6 - 3,  // Random position -3 to 3
                    0.5,  // Place models above table level
                    Math.random() * 6 - 3
                ],
                rotation: [0, Math.random() * 360, 0],  // Random Y rotation
                scale: [1, 1, 1],
                owner: 'ui_user',
                properties: {
                    type: 'model',
                    model_path: glbFile,
                    color: [1, 1, 1]  // White by default
                }
            });
            
            // Update UI
            lastEntityName = modelName;
            
            // Show loading feedback
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚è≥ Loading...';
            button.disabled = true;
            
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 3000);
        }
        
        function loadRandomGLBModel() {
            const models = ['cat', 'eagle'];
            const randomModel = models[Math.floor(Math.random() * models.length)];
            loadGLBModel(randomModel);
        }
        
        // Enhanced GLB model loading with positioning options
        function loadGLBModelAt(modelType, x, y, z, color = [1, 1, 1], scale = [1, 1, 1]) {
            if (!gameController || !gameController.isConnected) {
                console.warn('Not connected to server');
                return;
            }
            
            glbModelCounter++;
            const modelName = `${modelType}_${glbModelCounter}`;
            const glbFile = `${modelType}.glb`;
            
            gameController.sendMessage('create_entity', {
                name: modelName,
                template: glbFile,
                position: [x, y, z],
                rotation: [0, 0, 0],
                scale: scale,
                owner: 'ui_user',
                properties: {
                    type: 'model',
                    model_path: glbFile,
                    color: color
                }
            });
            
            return modelName;
        }
        
        // Quick preset combinations
        function loadModelShowcase() {
            if (!gameController || !gameController.isConnected) {
                alert('Not connected to server');
                return;
            }
            
            clearScene();
            
            setTimeout(() => {
                // Load multiple models in a line
                loadGLBModelAt('cat', -2, 0.5, 0, [1, 1, 1], [1, 1, 1]);
                loadGLBModelAt('eagle', 0, 0.5, 0, [0.8, 0.8, 1], [1.2, 1.2, 1.2]);
                loadGLBModelAt('cat', 2, 0.5, 0, [1, 0.8, 0.8], [0.8, 0.8, 0.8]);
                
                // Set camera for good view
                setTimeout(() => {
                    gameController.sendMessage('set_camera', {
                        position: [4, 4, 4],
                        target: [0, 0, 0]
                    });
                }, 1000);
            }, 500);
        }
        
        // Update UI when connection status changes
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            statusEl.className = status;
            
            switch(status) {
                case 'connected':
                    statusEl.innerHTML = '‚úÖ Connected to server';
                    break;
                case 'disconnected':
                    statusEl.innerHTML = '‚ùå Disconnected from server';
                    break;
                case 'connecting':
                    statusEl.innerHTML = 'üîÑ Connecting to server...';
                    break;
            }
        }
        
        // Update entity list in UI - shows all object types
        function updateEntityList(entities) {
            const countEl = document.getElementById('entity-count');
            const listEl = document.getElementById('entity-list');
            
            // Get all object types from the entity manager
            let allObjects = [];
            
            // Add VTTL entities
            Object.values(entities).forEach(entity => {
                allObjects.push({
                    name: entity.name,
                    type: entity.template,
                    position: entity.position,
                    category: 'Entity'
                });
            });
            
            // Add models, lights, cameras from entity manager if available
            if (window.gameController && window.gameController.entityManager) {
                const em = window.gameController.entityManager;
                
                // Add models
                em.getAllModels().forEach(model => {
                    if (!allObjects.find(obj => obj.name === model.name)) {
                        allObjects.push({
                            name: model.name,
                            type: model.data?.modelType || 'model',
                            position: model.data?.position || [0, 0, 0],
                            category: 'Model'
                        });
                    }
                });
                
                // Add lights
                em.getAllLights().forEach(light => {
                    allObjects.push({
                        name: light.name,
                        type: light.data?.lightType || 'light',
                        position: light.data?.position || [0, 0, 0],
                        category: 'Light'
                    });
                });
                
                // Add cameras
                em.getAllCameras().forEach(camera => {
                    allObjects.push({
                        name: camera.name,
                        type: camera.data?.cameraType || 'camera',
                        position: camera.data?.position || [0, 0, 0],
                        category: 'Camera'
                    });
                });
            }
            
            const count = allObjects.length;
            countEl.textContent = count;
            
            listEl.innerHTML = '';
            allObjects.forEach(obj => {
                const div = document.createElement('div');
                div.className = 'entity-item';
                div.innerHTML = `
                    <strong>${obj.name}</strong> <span style="color: #666;">[${obj.category}]</span><br>
                    ${obj.type} | ${obj.position.map(p => p.toFixed(1)).join(', ')}
                `;
                listEl.appendChild(div);
            });
        }
        
        // Hide loading screen when ready
        function hideLoading() {
            const loading = document.getElementById('loading');
            loading.style.display = 'none';
        }
    </script>
</body>
</html>